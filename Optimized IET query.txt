WITH temp_cpn AS
    (
    SELECT CPN.*,
        DSG.TKT_DSG,
        DSG.DCN_GRP,
        DSG.DCN_GRP_NAM
        FROM
        (
       SELECT CPN.ACCT_AIRLN_IATA_CD,
        CPN.TICKET_NBR,
        CPN.TICKET_ISSUE_DT,
        CPN.SCHD_SEG_BEGIN_LCL_DT,
        CPN.COUPON_STATUS_CD,
        CPN.SEG_DEP_AIRPRT_IATA_CD,
        CPN.SEG_ARVL_AIRPRT_IATA_CD,
        CPN.COUPON_NBR,
        CPN.OPERAT_FLIGHT_NBR,
        CPN.OA_OPERAT_IATA_CD,
        src.ACCT_FARE_CLASS_CD,
        CPN.FLOWN_FARE_CLASS_CD,
        CPN.FARE_BASE_CD,
        CPN.TICKET_DISCNT_CD,
        src.COUPON_PRORTE_AMT
            FROM SBVCR_PROD_PKG.TRAVEL_COUPON CPN
            LEFT OUTER JOIN SBVCR_PROD_PKG.TRAVEL_COUPON_REVNUE_PRORTE src
            ON  CPN.ACCT_AIRLN_IATA_CD = src.ACCT_AIRLN_IATA_CD
            AND CPN.TICKET_NBR = src.TICKET_NBR
            AND CPN.TICKET_ISSUE_DT = src.TICKET_ISSUE_DT
            AND CPN.ENTLMNT_NBR=src.ENTLMNT_NBR
            WHERE CPN.TICKET_ISSUE_DT BETWEEN (ADD_MONTHS(CURRENT_DATE, -EXTRACT(MONTH FROM CURRENT_DATE  ) + 1) - EXTRACT(DAY FROM CURRENT_DATE ) + 1)
            AND (CURRENT_DATE - EXTRACT(DAY FROM CURRENT_DATE )
            )) CPN
        INNER JOIN PROD_MIRSCTL_VWS.CTL_TKT_DSG DSG 
        ON COALESCE(CPN.TICKET_DISCNT_CD, '') = DSG.TKT_DSG 
        AND CPN.TICKET_ISSUE_DT BETWEEN DSG.EFF_DT AND DSG.DIS_DT 
        AND DSG.NM LIKE '%INDUSTRY DISCOUNT%'
    ), temp_FARE AS
    (
     SELECT FARE_BASE_CD,FARE_GROUP_SUBSET_DESC
        FROM ( 
        SELECT a.FARE_BASE_CD,
        a.FARE_BASE_EFF_DT,
        a.FARE_GROUP_SUBSET_DESC,
        ROW_NUMBER() OVER(PARTITION BY a.FARE_BASE_CD ORDER BY a.FARE_BASE_EFF_DT DESC) AS max_eff_dt_NBR
        FROM prod_mirs_vws.fare_base_hist a
        INNER JOIN
        (SELECT temp_cpn.FARE_BASE_CD FROM temp_cpn GROUP BY 1
         ) fare ON a.FARE_BASE_CD = fare.FARE_BASE_CD       
         )AA
        WHERE  max_eff_dt_NBR =1
    ), temp_cpn2 AS
    (
    SELECT CPN.ACCT_AIRLN_IATA_CD,
        CPN.TICKET_NBR,
        CPN.TICKET_ISSUE_DT,
        CPN.SCHD_SEG_BEGIN_LCL_DT,
        CPN.COUPON_STATUS_CD,
        CPN.SEG_DEP_AIRPRT_IATA_CD,
        CPN.SEG_ARVL_AIRPRT_IATA_CD,
        CPN.COUPON_NBR,
        CPN.OPERAT_FLIGHT_NBR,
        CPN.OA_OPERAT_IATA_CD,
        CPN.ACCT_FARE_CLASS_CD,
        CPN.FLOWN_FARE_CLASS_CD,
        CPN.TKT_DSG,
        CPN.DCN_GRP,
        CPN.DCN_GRP_NAM,
        CPN.FARE_BASE_CD,
        COALESCE(FARE.FARE_GROUP_SUBSET_DESC, 'N/A') AS fare_group_subset_desc
        ,CPN.COUPON_PRORTE_AMT
        FROM temp_cpn CPN
        LEFT OUTER JOIN temp_fare FARE ON CPN.FARE_BASE_CD = FARE.FARE_BASE_CD
    )
    SELECT TKT.ACCT_AIRLN_IATA_CD,
        TKT.TICKET_NBR,
        CPN.COUPON_NBR,
        TKT.TICKET_ISSUE_DT,
        TKT.ACCT_AIRLN_NBR,
        CPN.SCHD_SEG_BEGIN_LCL_DT AS departure_dt,
        CPN.COUPON_STATUS_CD,
        CPN.SEG_DEP_AIRPRT_IATA_CD,
        CPN.SEG_ARVL_AIRPRT_IATA_CD,
        CPN.OPERAT_FLIGHT_NBR,
        CPN.OA_OPERAT_IATA_CD,
        CPN.ACCT_FARE_CLASS_CD,
        CPN.FLOWN_FARE_CLASS_CD,
        CUST.PNR_PAX_NM,
        TKT.TOUR_CD_BOX_TXT,
        CPN.TKT_DSG AS ticket_designator,
        CPN.DCN_GRP AS tkt_desgntr_desc,
        CPN.DCN_GRP_NAM AS ticket_desgntr_group_desc,
        CPN.FARE_BASE_CD,
        CPN.fare_group_subset_desc,
        TKT.SLS_OUTLET_PCC_CD,
        TKT.PNR_LOCTR_ID,
        TKT.TICKET_ENDORS_RSTRCT_DESC
       ,CPN.COUPON_PRORTE_AMT
        FROM temp_cpn2 CPN
        INNER JOIN
        (
        SELECT SBVCR_PROD_PKG.TICKET.ACCT_AIRLN_IATA_CD,
            SBVCR_PROD_PKG.TICKET.TICKET_NBR,
            SBVCR_PROD_PKG.TICKET.TICKET_ISSUE_DT,
            SBVCR_PROD_PKG.TICKET.ACCT_AIRLN_NBR,
            SBVCR_PROD_PKG.TICKET.TOUR_CD_BOX_TXT,
            SBVCR_PROD_PKG.TICKET.SLS_OUTLET_PCC_CD,
            SBVCR_PROD_PKG.TICKET.PNR_LOCTR_ID,
            SBVCR_PROD_PKG.TICKET.TICKET_ENDORS_RSTRCT_DESC
            FROM SBVCR_PROD_PKG.TICKET
            WHERE SBVCR_PROD_PKG.TICKET.TICKET_ISSUE_DT BETWEEN (ADD_MONTHS(CURRENT_DATE, -EXTRACT(MONTH
            FROM CURRENT_DATE
            ) + 1) - EXTRACT(DAY
            FROM CURRENT_DATE
            ) + 1)
            AND (CURRENT_DATE - EXTRACT(DAY
            FROM CURRENT_DATE
            ))
                AND  SBVCR_PROD_PKG.TICKET.ACCT_AIRLN_NBR <> '001'
        ) TKT ON TKT.ACCT_AIRLN_IATA_CD = CPN.ACCT_AIRLN_IATA_CD AND TKT.TICKET_NBR = CPN.TICKET_NBR AND TKT.TICKET_ISSUE_DT = CPN.TICKET_ISSUE_DT
        INNER JOIN
        (
        SELECT SBVCR_PROD_PKG.PARTY_TICKET.ACCT_AIRLN_IATA_CD,
            SBVCR_PROD_PKG.PARTY_TICKET.TICKET_NBR,
            SBVCR_PROD_PKG.PARTY_TICKET.TICKET_ISSUE_DT,
            SBVCR_PROD_PKG.PARTY_TICKET.PNR_PAX_NM
            FROM SBVCR_PROD_PKG.PARTY_TICKET
            WHERE SBVCR_PROD_PKG.PARTY_TICKET.ACCT_AIRLN_IATA_CD <> 'AA'
                AND  SBVCR_PROD_PKG.PARTY_TICKET.TICKET_ISSUE_DT BETWEEN (ADD_MONTHS(CURRENT_DATE, -EXTRACT(MONTH
            FROM CURRENT_DATE
            ) + 1) - EXTRACT(DAY
            FROM CURRENT_DATE
            ) + 1)
            AND (CURRENT_DATE - EXTRACT(DAY
            FROM CURRENT_DATE
            )
            )) CUST ON TKT.ACCT_AIRLN_IATA_CD = CUST.ACCT_AIRLN_IATA_CD AND TKT.TICKET_NBR = CUST.TICKET_NBR AND TKT.TICKET_ISSUE_DT = CUST.TICKET_ISSUE_DT
    
    UNION
    SELECT TKT.ACCT_AIRLN_IATA_CD,
        TKT.TICKET_NBR,
        CPN.COUPON_NBR,
        TKT.TICKET_ISSUE_DT,
        TKT.ACCT_AIRLN_NBR,
        CPN.SCHD_SEG_BEGIN_LCL_DT AS departure_dt,
        CPN.COUPON_STATUS_CD,
        CPN.SEG_DEP_AIRPRT_IATA_CD,
        CPN.SEG_ARVL_AIRPRT_IATA_CD,
        CPN.OPERAT_FLIGHT_NBR,
        CPN.OA_OPERAT_IATA_CD,
        CPN.ACCT_FARE_CLASS_CD,
        CPN.FLOWN_FARE_CLASS_CD,
        CUST.PNR_PAX_NM,
        TKT.TOUR_CD_BOX_TXT,
        CPN.TKT_DSG AS ticket_designator,
        CPN.DCN_GRP AS tkt_desgntr_desc,
        CPN.DCN_GRP_NAM AS ticket_desgntr_group_desc,
        CPN.FARE_BASE_CD,
        CPN.fare_group_subset_desc,
        TKT.SLS_OUTLET_PCC_CD,
        TKT.PNR_LOCTR_ID,
        TKT.TICKET_ENDORS_RSTRCT_DESC
        ,CPN.COUPON_PRORTE_AMT
        FROM temp_cpn2 CPN
        INNER JOIN
        (
        SELECT SBVCR_PROD_PKG.TICKET.ACCT_AIRLN_IATA_CD,
            SBVCR_PROD_PKG.TICKET.TICKET_NBR,
            SBVCR_PROD_PKG.TICKET.TICKET_ISSUE_DT,
            SBVCR_PROD_PKG.TICKET.ACCT_AIRLN_NBR,
            SBVCR_PROD_PKG.TICKET.TOUR_CD_BOX_TXT,
            SBVCR_PROD_PKG.TICKET.SLS_OUTLET_PCC_CD,
            SBVCR_PROD_PKG.TICKET.PNR_LOCTR_ID,
            SBVCR_PROD_PKG.TICKET.TICKET_ENDORS_RSTRCT_DESC
            FROM SBVCR_PROD_PKG.TICKET
            WHERE SBVCR_PROD_PKG.TICKET.TICKET_ISSUE_DT BETWEEN (ADD_MONTHS(CURRENT_DATE, -EXTRACT(MONTH
            FROM CURRENT_DATE
            ) + 1) - EXTRACT(DAY
            FROM CURRENT_DATE
            ) + 1)
            AND (CURRENT_DATE - EXTRACT(DAY
            FROM CURRENT_DATE
            ))
                AND  SBVCR_PROD_PKG.TICKET.ACCT_AIRLN_NBR = '001'
        ) TKT ON TKT.ACCT_AIRLN_IATA_CD = CPN.ACCT_AIRLN_IATA_CD AND TKT.TICKET_NBR = CPN.TICKET_NBR AND TKT.TICKET_ISSUE_DT = CPN.TICKET_ISSUE_DT
        INNER JOIN
        (
        SELECT SBVCR_PROD_PKG.PARTY_TICKET.ACCT_AIRLN_IATA_CD,
            SBVCR_PROD_PKG.PARTY_TICKET.TICKET_NBR,
            SBVCR_PROD_PKG.PARTY_TICKET.TICKET_ISSUE_DT,
            SBVCR_PROD_PKG.PARTY_TICKET.PNR_PAX_NM
            FROM SBVCR_PROD_PKG.PARTY_TICKET
            WHERE SBVCR_PROD_PKG.PARTY_TICKET.ACCT_AIRLN_IATA_CD = 'AA'
                AND  SBVCR_PROD_PKG.PARTY_TICKET.TICKET_ISSUE_DT BETWEEN (ADD_MONTHS(CURRENT_DATE, -EXTRACT(MONTH
            FROM CURRENT_DATE
            ) + 1) - EXTRACT(DAY
            FROM CURRENT_DATE
            ) + 1)
            AND (CURRENT_DATE - EXTRACT(DAY
            FROM CURRENT_DATE
            )
            )) CUST ON TKT.ACCT_AIRLN_IATA_CD = CUST.ACCT_AIRLN_IATA_CD AND TKT.TICKET_NBR = CUST.TICKET_NBR AND TKT.TICKET_ISSUE_DT = CUST.TICKET_ISSUE_DT
 
 